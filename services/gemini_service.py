# services/gemini_service.py
import logging
import google.generativeai as genai
import json
from config_reader import config
from typing import Optional, Dict, Any

logger = logging.getLogger(__name__)

# –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ Gemini API
try:
    if config.gemini_api_key:
        genai.configure(api_key=config.gemini_api_key.get_secret_value())
        logger.info("Google Gemini API —Å–∫–æ–Ω—Ñ—ñ–≥—É—Ä–æ–≤–∞–Ω–æ.")
    else:
        logger.warning("GEMINI_API_KEY –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. AI-—Å–µ—Ä–≤—ñ—Å–∏ –±—É–¥–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ.")
except Exception as e:
    logger.error(f"–ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó Gemini: {e}")

async def rewrite_text_with_ai(text_to_rewrite: str, product_name: str) -> str:
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–µ—Ä–µ–ø–∏—Å—É—î –æ–ø–∏—Å —Ç–æ–≤–∞—Ä—É (–¥–ª—è –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥—É).
    """
    if not config.gemini_api_key:
        logger.warning("–†–µ—Ä–∞–π—Ç–∏–Ω–≥ –ø—Ä–æ–ø—É—â–µ–Ω–æ (–Ω–µ–º–∞—î API key).")
        return text_to_rewrite

    try:
        model = genai.GenerativeModel(
            model_name="gemini-1.5-flash-latest",
            system_instruction=(
                "–¢–∏ ‚Äì –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –∫–æ–ø—ñ—Ä–∞–π—Ç–µ—Ä –¥–ª—è –¢–µ–ª–µ–≥—Ä–∞–º-–º–∞–≥–∞–∑–∏–Ω—É 'TAVERNA'. "
                "–¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äì –ø–µ—Ä–µ–ø–∏—Å–∞—Ç–∏ –æ–ø–∏—Å —Ç–æ–≤–∞—Ä—É. –°—Ç–∏–ª—å: –≤–ø–µ–≤–Ω–µ–Ω–∏–π, –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π, –∑ –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —è–∫—ñ—Å—Ç—å. "
                "–°—Ç—Ä—É–∫—Ç—É—Ä—É–π —Ç–µ–∫—Å—Ç, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –º–∞—Ä–∫–æ–≤–∞–Ω—ñ —Å–ø–∏—Å–∫–∏ (‚ñ™Ô∏è –∞–±–æ ‚úÖ). "
                "–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –¥–æ—Ä–µ—á–Ω—ñ –µ–º–æ–¥–∑—ñ (üõ°Ô∏è, üí™, üî•). "
                "–ù–ï –¥–æ–¥–∞–≤–∞–π —Ü—ñ–Ω—É, –∞—Ä—Ç–∏–∫—É–ª, –ø–æ—Å–∏–ª–∞–Ω–Ω—è –∞–±–æ –∑–∞–∫–ª–∏–∫–∏ –¥–æ –¥—ñ—ó. –¢—ñ–ª—å–∫–∏ –æ–ø–∏—Å."
            )
        )
        
        prompt = f"–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É: '{product_name}'. –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –æ–ø–∏—Å –¥–ª—è —Ä–µ—Ä–∞–π—Ç—É:\n---\n{text_to_rewrite}"
        
        response = await model.generate_content_async(
            prompt,
            generation_config=genai.types.GenerationConfig(temperature=0.7, max_output_tokens=4096)
        )
        
        rewritten_text = response.text.strip()
        logger.info(f"‚úÖ Gemini —É—Å–ø—ñ—à–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞–≤ —Ç–µ–∫—Å—Ç –¥–ª—è '{product_name}'")
        return rewritten_text
        
    except Exception as e:
        logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –∑–∞–ø–∏—Ç—É –¥–æ Gemini API (rewrite): {e}", exc_info=True)
        return text_to_rewrite

# ---
# [–ù–û–í–ê –§–£–ù–ö–¶–Ü–Ø - –§–ê–ó–ê 3.4] (–¢–≤—ñ–π "–ì–ª–æ–±–∞–ª—å–Ω–∏–π –ü–ª–∞–Ω 13 + 17")
# ---
async def extract_product_attributes_with_ai(
    raw_text: str, 
    category_hint: str
) -> Optional[Dict[str, Any]]:
    """
    "AI-–ö–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ç–æ—Ä". –í–∏—Ç—è–≥—É—î —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ (–∞—Ç—Ä–∏–±—É—Ç–∏ —Ç–∞ –æ–ø—Ü—ñ—ó)
    –∑ —Ö–∞–æ—Ç–∏—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É –ø–æ—Å—Ç–∞ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞ (URL/Telegram).
    """
    if not config.gemini_api_key:
        logger.warning("–í–∏–¥–æ–±—É–≤–∞–Ω–Ω—è –∞—Ç—Ä–∏–±—É—Ç—ñ–≤ –ø—Ä–æ–ø—É—â–µ–Ω–æ (–Ω–µ–º–∞—î API key).")
        return None

    # –¶–µ "–º–æ–∑–æ–∫" –Ω–∞—à–æ–≥–æ –≥–Ω—É—á–∫–æ–≥–æ –ø–∞—Ä—Å–µ—Ä–∞.
    # –ú–∏ –¥–∞—î–º–æ Gemini —Ä–æ–ª—å —ñ –ø—Ä–æ—Å–∏–º–æ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ *–ª–∏—à–µ* JSON.
    system_prompt = f"""
–¢–∏ - AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è E-commerce –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏ TavernaGroup.
–¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è - –∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç –æ–ø–∏—Å—É —Ç–æ–≤–∞—Ä—É –≤—ñ–¥ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞ —ñ –≤–∏—Ç—è–≥—É–≤–∞—Ç–∏ –∑ –Ω—å–æ–≥–æ *–ª–∏—à–µ* —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ —É —Ñ–æ—Ä–º–∞—Ç—ñ JSON.
–ö–∞—Ç–µ–≥–æ—Ä—ñ—è —Ü—å–æ–≥–æ —Ç–æ–≤–∞—Ä—É: "{category_hint}".

–ü—Ä–∞–≤–∏–ª–∞ JSON:
1.  `name`: –û—á–∏—â–µ–Ω–∞ –Ω–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É (–±–µ–∑ —Ü—ñ–Ω–∏, —Ä–æ–∑–º—ñ—Ä—ñ–≤, –∫–æ–ª—å–æ—Ä—ñ–≤).
2.  `attributes`: –û–±'—î–∫—Ç –∑ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏ (–ë—Ä–µ–Ω–¥, –ú–∞—Ç–µ—Ä—ñ–∞–ª, –†—ñ–∫, –ö—Ä–∞—ó–Ω–∞, –î—ñ–∞–≥–æ–Ω–∞–ª—å...).
3.  `options`: –ú–∞—Å–∏–≤ –æ–ø—Ü—ñ–π, —è–∫—ñ –≤–ø–ª–∏–≤–∞—é—Ç—å –Ω–∞ —Ü—ñ–Ω—É/SKU (–ö–æ–ª—ñ—Ä, –†–æ–∑–º—ñ—Ä, –í–∞–≥–∞, –ü–∞–º'—è—Ç—å...).
4.  `base_price`: –î—Ä–æ–ø-—Ü—ñ–Ω–∞, –∑–Ω–∞–π–¥–µ–Ω–∞ –≤ —Ç–µ–∫—Å—Ç—ñ (—Ç—ñ–ª—å–∫–∏ —á–∏—Å–ª–æ).

–Ø–∫—â–æ —Ç–∏ –Ω–µ –º–æ–∂–µ—à –∑–Ω–∞–π—Ç–∏ –¥–∞–Ω—ñ, –ø–æ–≤–µ—Ä—Ç–∞–π null.
–ü–æ–≤–µ—Ä—Ç–∞–π *–¢–Ü–õ–¨–ö–ò* JSON, –±–µ–∑ –∂–æ–¥–Ω–æ–≥–æ —ñ–Ω—à–æ–≥–æ —Ç–µ–∫—Å—Ç—É.

–ü—Ä–∏–∫–ª–∞–¥ 1 (–û–¥—è–≥):
–í—Ö—ñ–¥: "–¢–∞–∫—Ç–∏—á–Ω–∞ —Å–æ—Ä–æ—á–∫–∞ (—É–±–∞–∫—Å) –º—É–ª—å—Ç–∏–∫–∞–º. –†–æ–∑–º—ñ—Ä–∏ S, M, L. –ú–∞—Ç–µ—Ä—ñ–∞–ª: –†—ñ–ø-—Å—Ç–æ–ø. –¶—ñ–Ω–∞ 900 –≥—Ä–Ω."
–í–∏—Ö—ñ–¥:
{{
  "name": "–¢–∞–∫—Ç–∏—á–Ω–∞ —Å–æ—Ä–æ—á–∫–∞ (—É–±–∞–∫—Å)",
  "attributes": {{ "–ú–∞—Ç–µ—Ä—ñ–∞–ª": "–†—ñ–ø-—Å—Ç–æ–ø" }},
  "options": [
    {{ "name": "–ö–æ–ª—ñ—Ä", "values": ["–º—É–ª—å—Ç–∏–∫–∞–º"] }},
    {{ "name": "–†–æ–∑–º—ñ—Ä", "values": ["S", "M", "L"] }}
  ],
  "base_price": 900
}}

–ü—Ä–∏–∫–ª–∞–¥ 2 (–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞):
–í—Ö—ñ–¥: "–ù–æ–≤–∏–π iPhone 15 Pro, 256GB, –∫–æ–ª—ñ—Ä Natural Titanium. –í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ! –¶—ñ–Ω–∞ 45000 UAH."
–í–∏—Ö—ñ–¥:
{{
  "name": "iPhone 15 Pro",
  "attributes": {{ "–ë—Ä–µ–Ω–¥": "Apple", "–ú–æ–¥–µ–ª—å": "iPhone 15 Pro" }},
  "options": [
    {{ "name": "–ü–∞–º'—è—Ç—å", "values": ["256GB"] }},
    {{ "name": "–ö–æ–ª—ñ—Ä", "values": ["Natural Titanium"] }}
  ],
  "base_price": 45000
}}

–ü—Ä–∏–∫–ª–∞–¥ 3 (–ö–∞–≤–∞):
–í—Ö—ñ–¥: "–ö–∞–≤–∞ '–ê—Ä–∞–±—ñ–∫–∞ –ë—Ä–∞–∑–∏–ª—ñ—è'. –í–∞–≥–∞: 250–≥ –∞–±–æ 1–∫–≥. –ü–æ–º–µ–ª: –ø—ñ–¥ —Ç—É—Ä–∫—É, –ø—ñ–¥ –µ—Å–ø—Ä–µ—Å–æ. 250–≥ = 300 –≥—Ä–Ω, 1–∫–≥ = 1000 –≥—Ä–Ω."
–í–∏—Ö—ñ–¥:
{{
  "name": "–ö–∞–≤–∞ '–ê—Ä–∞–±—ñ–∫–∞ –ë—Ä–∞–∑–∏–ª—ñ—è'",
  "attributes": {{ "–ö—Ä–∞—ó–Ω–∞": "–ë—Ä–∞–∑–∏–ª—ñ—è", "–¢–∏–ø": "–ê—Ä–∞–±—ñ–∫–∞" }},
  "options": [
    {{ "name": "–í–∞–≥–∞", "values": ["250–≥", "1–∫–≥"] }},
    {{ "name": "–ü–æ–º–µ–ª", "values": ["–ø—ñ–¥ —Ç—É—Ä–∫—É", "–ø—ñ–¥ –µ—Å–ø—Ä–µ—Å–æ"] }}
  ],
  "base_price": 300
}}
"""
    
    try:
        model = genai.GenerativeModel(
            model_name="gemini-1.5-flash-latest",
            system_instruction=system_prompt,
            generation_config=genai.types.GenerationConfig(
                response_mime_type="application/json", # –ü—Ä–æ—Å–∏–º–æ Gemini *–≥–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏* JSON
                temperature=0.0 # –ù–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–∞ —Ç–æ—á–Ω—ñ—Å—Ç—å, –∞ –Ω–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ñ—Å—Ç—å
            )
        )
        
        response = await model.generate_content_async(raw_text)
        
        # –í–∏—Ç—è–≥—É—î–º–æ —á–∏—Å—Ç–∏–π JSON
        json_data = json.loads(response.text)
        logger.info(f"‚úÖ Gemini —É—Å–ø—ñ—à–Ω–æ –≤–∏—Ç—è–≥–Ω—É–≤ –∞—Ç—Ä–∏–±—É—Ç–∏: {json_data}")
        return json_data
        
    except Exception as e:
        logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –∑–∞–ø–∏—Ç—É –¥–æ Gemini API (extract): {e}", exc_info=True)
        return None