<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Вхід / Реєстрація</title>
    <script src="js/app.js"></script> <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #777777);
            --tg-link: var(--tg-theme-link-color, #007bff);
            --tg-button: var(--tg-theme-button-color, #007bff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --tg-error: #FF3B30;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 90vh;
        }
        h1 { text-align: center; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input {
            width: 100%; box-sizing: border-box; padding: 12px 15px; font-size: 16px;
            border: 2px solid var(--tg-secondary-bg); background-color: var(--tg-secondary-bg);
            color: var(--tg-text); border-radius: 10px; outline: none;
        }
        .form-group input:focus { border-color: var(--tg-link); }
        .error-message { color: var(--tg-error); font-size: 13px; margin-top: 5px; display: none; }
        
        button {
            width: 100%; padding: 15px; font-size: 18px; font-weight: 600; border: none;
            border-radius: 12px; background-color: var(--tg-button);
            color: var(--tg-button-text); cursor: pointer; margin-top: 10px;
        }
        button:disabled { background-color: var(--tg-hint); }
        
        .divider {
            text-align: center;
            color: var(--tg-hint);
            margin: 20px 0;
            font-size: 14px;
        }
        #auth-container { display: none; }
    </style>
</head>
<body>
    
    <div id="loader">Авторизація...</div>

    <div id="auth-container">
        <h1>Кабінет Партнера</h1>
        
        <div class="form-group">
            <button id="tg-login-btn">Увійти через Telegram</button>
        </div>
        
        <div class="divider">--- АБО ---</div>

        <form id="email-form" onsubmit="return false;">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="admin@taverna.ua">
            </div>
            <div class="form-group">
                <label for="password">Пароль</label>
                <input type="password" id="password" placeholder="••••••••">
            </div>
            <div class="error-message" id="error-login"></div>
            
            <button id="email-login-btn">Увійти</button>
            <button id="email-register-btn" style="background-color: var(--tg-hint);">Зареєструвати Email</button>
        </form>
    </div>

    <script src="js/app.js"></script>
    <script>
        // Елементи DOM
        const loader = document.getElementById('loader');
        const authContainer = document.getElementById('auth-container');
        const errorLogin = document.getElementById('error-login');
        
        // --- 1. Логіка: Що робити після успішного логіну (ОНОВЛЕНО) ---
        async function onLoginSuccess(tokenResponse) {
            tg.HapticFeedback.notificationOccurred('success');
            // Зберігаємо токен та дані юзера в localStorage
            localStorage.setItem('jwt_token', tokenResponse.access_token);
            localStorage.setItem('current_user', JSON.stringify(tokenResponse.user));
            
            const user = tokenResponse.user;
            
            // (План 21/23) - Перевіряємо, чи це Постачальник (чи Адмін)
            if (user.role === 'supplier' || user.role === 'admin') {
                
                // Перевіряємо, чи є у нього вже профіль
                // (Використовуємо /supplier/stats як перевірку)
                const stats = await apiCall('/api/v1/supplier/stats');
                
                if (stats && !stats.error) {
                    // УСПІХ: Профіль існує. Перехід в Кабінет.
                    window.location.href = 'supplier-dashboard.html';
                } else {
                    // ПОМИЛКА 404: Профіль не знайдено. Перехід на реєстрацію.
                    window.location.href = 'supplier-register.html';
                }
            } else {
                // Якщо це звичайний юзер
                tg.showAlert('Цей розділ лише для партнерів. Перехід в каталог.');
                window.location.href = 'index.html';
            }
        }

        // --- 2. Обробники Кнопок ---
        
        // 2.1. Вхід через Telegram
        document.getElementById('tg-login-btn').onclick = async () => {
            const btn = document.getElementById('tg-login-btn');
            btn.disabled = true;
            btn.innerText = 'Авторизація...';
            
            const initData = tg.initData;
            if (!initData) {
                tg.showAlert("Помилка: не вдалося отримати дані Telegram.");
                btn.disabled = false;
                btn.innerText = 'Увійти через Telegram';
                return;
            }
            
            const data = await apiCall('/api/v1/auth/login-telegram', 'POST', {
                initData: initData
            });
            
            if (data && data.access_token) {
                onLoginSuccess(data);
            } else {
                tg.showAlert(data.detail || data.error || "Не вдалося увійти через Telegram.");
                btn.disabled = false;
                btn.innerText = 'Увійти через Telegram';
            }
        };
        
        // 2.2. Вхід через Email
        document.getElementById('email-login-btn').onclick = async () => {
            const btn = document.getElementById('email-login-btn');
            btn.disabled = true;
            btn.innerText = 'Вхід...';
            errorLogin.style.display = 'none';

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const data = await apiCall('/api/v1/auth/login-email', 'POST', {
                email: email,
                password: password
            });
            
            if (data && data.access_token) {
                onLoginSuccess(data);
            } else {
                errorLogin.innerText = data.detail || data.error || "Невірний email або пароль.";
                errorLogin.style.display = 'block';
                btn.disabled = false;
                btn.innerText = 'Увійти';
            }
        };
        
        // 2.3. Реєстрація Email (поки заглушка)
        document.getElementById('email-register-btn').onclick = () => {
            // TODO: Створити окрему сторінку `email-register.html`
            tg.showAlert('Функція реєстрації по Email/Паролю буде додана у наступному кроці.');
        };

        // --- 3. Головна Функція ---
async function main() {
            tg.ready();
            tg.BackButton.show();
            tg.BackButton.onClick(() => {
                window.location.href = 'index.html'; // Назад в каталог
            });
            
            // Перевіряємо, чи є валідний токен
            const token = localStorage.getItem('jwt_token');
            if(token) {
                // Якщо токен є, одразу редирект в кабінет
                logger.info("Знайдено токен, переадресація в кабінет...");
                window.location.href = 'supplier-dashboard.html';
                return;
            }

            // Якщо токена немає, показуємо форму
            loader.style.display = 'none';
            authContainer.style.display = 'block';
        }
        
        main();
    </script>
</body>
</html>