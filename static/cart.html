<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ú—ñ–π –ö–æ—à–∏–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #777777);
            --tg-link: var(--tg-theme-link-color, #007bff);
            --tg-button: var(--tg-theme-button-color, #007bff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: var(--tg-secondary-bg);
            color: var(--tg-text);
        }
        #loader { text-align: center; padding: 50px; font-size: 20px; color: var(--tg-hint); }
        #cart-container { display: none; padding-bottom: 120px; } /* –ó–∞–ø–∞—Å –¥–ª—è –∫–Ω–æ–ø–∫–∏ */
        
        .cart-item {
            display: flex;
            background-color: var(--tg-bg);
            border-radius: 12px;
            margin-bottom: 15px;
            padding: 10px;
            gap: 10px;
        }
        .cart-item-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            background-color: #e0e0e0;
        }
        .cart-item-info {
            flex-grow: 1;
        }
        .cart-item-name {
            font-weight: 600;
            color: var(--tg-text);
            margin-bottom: 5px;
        }
        .cart-item-options {
            font-size: 13px;
            color: var(--tg-hint);
            margin-bottom: 8px;
        }
        .cart-item-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--tg-link);
        }
        /* –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—é */
        .cart-item-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .qty-btn {
            width: 30px;
            height: 30px;
            font-size: 20px;
            border: none;
            border-radius: 50%;
            background-color: var(--tg-secondary-bg);
            color: var(--tg-text);
            cursor: pointer;
        }
        .quantity-value { /* –ó–º—ñ–Ω–µ–Ω–æ ID –Ω–∞ Class */
            font-size: 18px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }
        .remove-btn {
            font-size: 24px;
            color: var(--tg-hint);
            cursor: pointer;
            padding: 5px;
        }
        
        #empty-cart { text-align: center; padding: 40px; color: var(--tg-hint); display: none; }
        #empty-cart button {
            background-color: var(--tg-button);
            color: var(--tg-button-text);
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            margin-top: 15px;
            cursor: pointer;
        }
        
        /* –§—É—Ç–µ—Ä –∑ —Å—É–º–æ—é */
        #footer { 
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--tg-bg); 
            padding: 15px 20px 30px 20px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.08); 
            z-index: 100;
            display: none; /* –•–æ–≤–∞—î–º–æ, –ø–æ–∫–∏ –∫–æ—à–∏–∫ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è */
        }
        #total-price {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        #checkout-btn {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            background-color: var(--tg-button);
            color: var(--tg-button-text);
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ—à–∏–∫–∞...</div>
    <div id="cart-container">
        </div>
    <div id="empty-cart">
        <h2>üõí –í–∞—à –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</h2>
        <button id="go-to-catalog-btn">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É</button>
    </div>

    <div id="footer">
        <div id="total-price">–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞: 0 –≥—Ä–Ω</div>
        <button id="checkout-btn">–û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
    </div>

    <script src="js/app.js"></script>
    <script>
        // –ï–ª–µ–º–µ–Ω—Ç–∏ DOM
        const loader = document.getElementById('loader');
        const cartContainer = document.getElementById('cart-container');
        const emptyCartDiv = document.getElementById('empty-cart');
        const footer = document.getElementById('footer');
        const totalPriceEl = document.getElementById('total-price');
        const checkoutBtn = document.getElementById('checkout-btn');
        const goToCatalogBtn = document.getElementById('go-to-catalog-btn');

        let tgUser = null; // –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞
        
        // (–§—É–Ω–∫—Ü—ñ—ó apiCall —Ç–∞ authenticateUser —Ç–µ–ø–µ—Ä –≤ app.js)

        // 2. –§—É–Ω–∫—Ü—ñ—è "–º–∞–ª—é–≤–∞–Ω–Ω—è" –∫–æ—à–∏–∫–∞
        function renderCart(cartData) {
            const { items, total_price } = cartData;
            
            cartContainer.innerHTML = ''; // –û—á–∏—â—É—î–º–æ
            
            if (!items || items.length === 0) {
                loader.style.display = 'none';
                cartContainer.style.display = 'none';
                footer.style.display = 'none';
                emptyCartDiv.style.display = 'block';
                return;
            }
            
            items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'cart-item';
                itemEl.dataset.offerId = item.variant_offer_id;
                
                const imageUrl = item.image_url || 'https://via.placeholder.com/80';

                itemEl.innerHTML = `
                    <img src="${imageUrl}" alt="${item.name}" class="cart-item-img">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-options">${item.options_text || ''}</div>
                        <div class="cart-item-price">${item.price} –≥—Ä–Ω</div>
                        <div class="cart-item-controls">
                            <div class="quantity-selector">
                                <button class="qty-btn qty-minus" data-offer-id="${item.variant_offer_id}" data-qty="${item.quantity}">-</button>
                                <span class="quantity-value">${item.quantity}</span>
                                <button class="qty-btn qty-plus" data-offer-id="${item.variant_offer_id}" data-qty="${item.quantity}" data-max-qty="${item.max_quantity}">+</button>
                            </div>
                            <div class="remove-btn" data-offer-id="${item.variant_offer_id}">&#x2716;</div>
                        </div>
                    </div>
                `;
                cartContainer.appendChild(itemEl);
            });
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —Ñ—É—Ç–µ—Ä
            totalPriceEl.innerText = `–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞: ${total_price} –≥—Ä–Ω`;
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –∫–æ–Ω—Ç–µ–Ω—Ç
            loader.style.display = 'none';
            emptyCartDiv.style.display = 'none';
            cartContainer.style.display = 'block';
            footer.style.display = 'block';
            
            // 3. –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
            addEventListeners();
        }

        // 4. –î–æ–¥–∞–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤
        function addEventListeners() {
            // –ö–Ω–æ–ø–∫–∏ "+"
            document.querySelectorAll('.qty-plus').forEach(btn => {
                btn.onclick = (e) => {
                    tg.HapticFeedback.impactOccurred('light');
                    const offerId = e.currentTarget.dataset.offerId;
                    const newQty = parseInt(e.currentTarget.dataset.qty, 10) + 1;
                    const maxQty = parseInt(e.currentTarget.dataset.maxQty, 10);
                    if (newQty > maxQty) {
                        tg.showAlert(`–í–∏–±–∞—á—Ç–µ, –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –ª–∏—à–µ ${maxQty} —à—Ç.`);
                        return;
                    }
                    updateQuantity(offerId, newQty);
                };
            });
            
            // –ö–Ω–æ–ø–∫–∏ "-"
            document.querySelectorAll('.qty-minus').forEach(btn => {
                btn.onclick = (e) => {
                    tg.HapticFeedback.impactOccurred('light');
                    const offerId = e.currentTarget.dataset.offerId;
                    const newQty = parseInt(e.currentTarget.dataset.qty, 10) - 1;
                    // newQty=0 –±—É–¥–µ –æ–±—Ä–æ–±–ª–µ–Ω–æ —Å–µ—Ä–≤—ñ—Å–æ–º —è–∫ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
                    updateQuantity(offerId, newQty);
                };
            });
            
            // –ö–Ω–æ–ø–∫–∏ "–í–∏–¥–∞–ª–∏—Ç–∏" (X)
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.onclick = (e) => {
                    tg.HapticFeedback.impactOccurred('medium');
                    const offerId = e.currentTarget.dataset.offerId;
                    removeItem(offerId);
                };
            });
        }
        
        // 5. –§—É–Ω–∫—Ü—ñ—ó-–¥—ñ—ó
        async function updateQuantity(offerId, newQty) {
            const data = await apiCall('/api/v1/cart/update', 'POST', {
                user_id: tgUser.id,
                variant_offer_id: offerId,
                new_quantity: newQty
            });
            
            if (data && data.success) {
                renderCart(data.cart); // –ü–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ –∫–æ—à–∏–∫ –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ API
            } else {
                tg.showAlert(data.detail || data.message || "–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è");
            }
        }
        
        async function removeItem(offerId) {
            const data = await apiCall('/api/v1/cart/remove', 'POST', {
                user_id: tgUser.id,
                variant_offer_id: offerId
            });
            
            if (data && data.success) {
                renderCart(data.cart); // –ü–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ –∫–æ—à–∏–∫
            } else {
                tg.showAlert(data.detail || data.message || "–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è");
            }
        }

        // 6. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        async function main() {
            tg.ready();
            
            // 1. –°–ø–æ—á–∞—Ç–∫—É –∞–≤—Ç–æ—Ä–∏–∑—É—î–º–æ—Å—å
            tgUser = await authenticateUser();
            if (!tgUser) {
                loader.innerText = "–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó.";
                return;
            }
            
            // 2. –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –∫–Ω–æ–ø–∫–∏
            tg.BackButton.show();
            tg.BackButton.onClick(() => {
                // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –Ω–∞ –≥–æ–ª–æ–≤–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É –∫–∞—Ç–∞–ª–æ–≥—É
                window.location.href = 'index.html';
            });
            goToCatalogBtn.onclick = () => {
                window.location.href = 'index.html';
            };
            checkoutBtn.onclick = () => {
                // –¶–ï –ù–ê–® –ù–ê–°–¢–£–ü–ù–ò–ô –ö–†–û–ö (–§–∞–∑–∞ 2.8.4)
                window.location.href = 'checkout.html';
            };

            // 3. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ—à–∏–∫
            const data = await apiCall(`/api/v1/cart/${tgUser.id}`);
            if (data && !data.error) {
                renderCart(data);
            } else {
                loader.innerText = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ—à–∏–∫–∞.";
            }
        }
        
        main();
    </script>
</body>
</html>