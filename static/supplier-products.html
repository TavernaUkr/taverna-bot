<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Мої Товари</title>
    <script src="js/app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #777777);
            --tg-link: var(--tg-theme-link-color, #007bff);
            --tg-button: var(--tg-theme-button-color, #007bff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: var(--tg-secondary-bg);
            color: var(--tg-text);
        }
        #loader { text-align: center; padding: 50px; font-size: 20px; color: var(--tg-hint); }
        #product-list-container { display: none; padding-bottom: 20px; }
        
        .product-item {
            display: flex;
            background-color: var(--tg-bg);
            border-radius: 12px;
            margin-bottom: 15px;
            padding: 10px;
            gap: 10px;
        }
        .product-item-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            background-color: #e0e0e0;
        }
        .product-item-info {
            flex-grow: 1;
        }
        .product-item-name {
            font-weight: 600;
            color: var(--tg-text);
            margin-bottom: 5px;
        }
        .product-item-sku {
            font-size: 13px;
            color: var(--tg-hint);
            margin-bottom: 8px;
        }
        .product-item-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--tg-link);
        }
        .promote-btn {
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            background-color: var(--tg-button);
            color: var(--tg-button-text);
            cursor: pointer;
            margin-top: 10px;
        }
        .promote-btn:disabled {
             background-color: var(--tg-hint);
        }
    </style>
</head>
<body>

    <div id="loader">Завантаження товарів...</div>
    <div id="product-list-container">
        </div>
    
    <form id="liqpay-form" method="POST" action="https://www.liqpay.ua/api/3/checkout" accept-charset="utf-8" style="display: none;">
        <input type="hidden" name="data" id="liqpay-data" />
        <input type="hidden" name="signature" id="liqpay-signature" />
    </form>

    <script src="js/app.js"></script>
    <script>
        // Елементи DOM
        const loader = document.getElementById('loader');
        const productListContainer = document.getElementById('product-list-container');
        
        let tgUser = null; 
        let jwtToken = null; 

        // 1. Функція "малювання"
        function renderProducts(products) {
            productListContainer.innerHTML = '<h2>Мої Товари</h2>';
            
            if (!products || products.length === 0) {
                productListContainer.innerHTML += "<p>Ви ще не додали жодного товару.</p>";
                return;
            }
            
            products.forEach(product => {
                const itemEl = document.createElement('div');
                itemEl.className = 'product-item';
                
                const imageUrl = product.pictures && product.pictures.length > 0 
                    ? product.pictures[0] 
                    : 'https://via.placeholder.com/80';

                // Знаходимо мін. ціну (з Фази 2.8)
                const availableVariants = product.variants.filter(v => v.is_available);
                let minPrice = 0;
                if (availableVariants.length > 0) {
                    minPrice = Math.min(...availableVariants.map(v => v.final_price));
                }

                itemEl.innerHTML = `
                    <img src="${imageUrl}" alt="${product.name}" class="product-item-img">
                    <div class="product-item-info">
                        <div class="product-item-name">${product.name}</div>
                        <div class="product-item-sku">SKU: ${product.sku}</div>
                        <div class="product-item-price">${minPrice > 0 ? minPrice + ' грн' : 'Немає'}</div>
                        
                        <button class="promote-btn" data-product-id="${product.id}" data-name="${product.name}">
                            ⚡️ Платний Постинг (10 грн)
                        </button>
                    </div>
                `;
                productListContainer.appendChild(itemEl);
            });
            
            // Додаємо обробники кнопок
            addEventListeners();
        }

        // 2. Додавання обробників
        function addEventListeners() {
            document.querySelectorAll('.promote-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const productId = e.currentTarget.dataset.productId;
                    const productName = e.currentTarget.dataset.name;
                    // (План 20)
                    tg.showConfirm(
                        `Оплатити "Платний Постинг" (10 грн) для товару "${productName}"? Пост буде опубліковано негайно, поза чергою.`,
                        (ok) => {
                            if (ok) {
                                requestPaidPost(productId, e.currentTarget);
                            }
                        }
                    );
                };
            });
        }
        
        // 3. Функція-дія (План 5.2)
        async function requestPaidPost(productId, buttonElement) {
            buttonElement.disabled = true;
            buttonElement.innerText = 'Створення рахунку...';
            tg.HapticFeedback.impactOccurred('medium');
            
            const data = await apiCall('/api/v1/supplier/request-paid-post', 'POST', {
                product_id: productId,
                service_type: 'paid_post',
                amount: 10 // 10 грн (в копійках буде на бекенді)
            });
            
            if (data && data.data && data.signature) {
                // УСПІХ! Ми отримали дані для LiqPay
                // Заповнюємо приховану форму
                document.getElementById('liqpay-data').value = data.data;
                document.getElementById('liqpay-signature').value = data.signature;
                // "Натискаємо" на приховану форму, щоб перейти на LiqPay
                document.getElementById('liqpay-form').submit();
            } else {
                tg.showAlert(data.detail || data.error || "Не вдалося створити рахунок.");
                buttonElement.disabled = false;
                buttonElement.innerText = '⚡️ Платний Постинг (10 грн)';
            }
        }

        // 4. Завантаження сторінки
        async function main() {
            tg.ready();
            
            // 1. Спочатку авторизуємось
            tgUser = await authenticateUser();
            if (!tgUser) {
                loader.innerText = "Помилка авторизації.";
                return;
            }
            
            // 2. Налаштовуємо кнопки
            tg.BackButton.show();
            tg.BackButton.onClick(() => {
                window.location.href = 'supplier-dashboard.html';
            });
            
            // 3. Завантажуємо товари
            const data = await apiCall(`/api/v1/supplier/my-products`);
            if (data && !data.error) {
                loader.style.display = 'none';
                productListContainer.style.display = 'block';
                renderProducts(data);
            } else {
                loader.innerText = "Помилка завантаження товарів.";
            }
        }
        
        main();
    </script>
</body>
</html>