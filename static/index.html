<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Taverna</title>
    <script src="js/app.js"></script>
    <style>
        :root {
            /* –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–æ–ª—å–æ—Ä–∏ –∑ Telegram */
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #777777);
            --tg-link: var(--tg-theme-link-color, #007bff);
            --tg-button: var(--tg-theme-button-color, #007bff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            overscroll-behavior: none; /* –ó–∞–±–æ—Ä–æ–Ω–∞ "–≤—ñ–¥—Ç—è–≥—É–≤–∞–Ω–Ω—è" —Å—Ç–æ—Ä—ñ–Ω–∫–∏ */
        }
        #app-container {
            max-width: 600px;
            margin: 0 auto;
        }
        /* --- –ü–æ—à—É–∫ --- */
        #search-bar {
            position: sticky;
            top: 0;
            padding: 10px 0;
            background-color: var(--tg-bg);
            z-index: 10;
        }
        #search-input {
            width: 100%;
            box-sizing: border-box; /* –í—Ä–∞—Ö–æ–≤—É—î padding —É —à–∏—Ä–∏–Ω—É */
            padding: 12px 15px;
            font-size: 16px;
            border: none;
            background-color: var(--tg-secondary-bg);
            color: var(--tg-text);
            border-radius: 10px;
            outline: none;
        }
        #search-input::placeholder {
            color: var(--tg-hint);
        }
        /* --- –°—ñ—Ç–∫–∞ —Ç–æ–≤–∞—Ä—ñ–≤ --- */
        #product-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* –î–≤—ñ –∫–æ–ª–æ–Ω–∫–∏ */
            gap: 15px; /* –í—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ –∫–∞—Ä—Ç–∫–∞–º–∏ */
            margin-top: 15px;
        }
        .product-card {
            background-color: var(--tg-secondary-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            /* –î–æ–¥–∞–º–æ "–∫–ª—ñ–∫" –Ω–∞ –∫–∞—Ä—Ç–∫—É */
            cursor: pointer; 
            transition: transform 0.2s ease;
        }
        .product-card:active {
            transform: scale(0.98); /* –ï—Ñ–µ–∫—Ç –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è */
        }
        .product-card img {
            width: 100%;
            height: 150px; /* –§—ñ–∫—Å–æ–≤–∞–Ω–∞ –≤–∏—Å–æ—Ç–∞ */
            object-fit: cover; /* –ó–±–µ—Ä—ñ–≥–∞—î –ø—Ä–æ–ø–æ—Ä—Ü—ñ—ó */
            display: block;
            background-color: #e0e0e0;
        }
        .product-card-info {
            padding: 10px;
        }
        .product-card-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--tg-text);
            /* –û–±—Ä—ñ–∑–∫–∞ —Ç–µ–∫—Å—Ç—É (2 —Ä—è–¥–∫–∏) */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.5em; /* –†–µ–∑–µ—Ä–≤—É—î–º–æ –º—ñ—Å—Ü–µ –ø—ñ–¥ 2 —Ä—è–¥–∫–∏ */
        }
        .product-card-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--tg-link); /* –Ø—Å–∫—Ä–∞–≤–∏–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ —Ü—ñ–Ω—ñ */
            margin-top: 5px;
        }
        /* --- –°—Ç–∞–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è --- */
        .loader {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: var(--tg-hint);
        }
        /* --- –ù–û–í–ò–ô –°–¢–ò–õ–¨ –î–õ–Ø –ö–ù–û–ü–ö–ò –ö–û–®–ò–ö–ê --- */
        #cart-fab-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--tg-button);
            color: var(--tg-button-text);
            border: none;
            border-radius: 50%;
            font-size: 28px;
            line-height: 60px; /* –î–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è —ñ–∫–æ–Ω–∫–∏ */
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: pointer;
            z-index: 100;
        }
        /* --- –ù–û–í–ò–ô –°–¢–ò–õ–¨ –î–õ–Ø –ö–ù–û–ü–ö–ò –†–ï–Ñ–°–¢–†–ê–¶–Ü–á --- */
        #supplier-register-link {
            display: block;
            text-align: center;
            padding: 10px;
            font-size: 14px;
            color: var(--tg-hint);
            margin-top: 20px;
            text-decoration: none;
        }
        #supplier-register-link u {
            color: var(--tg-link);
            cursor: pointer;
        }
        /* --- –ù–û–í–ò–ô –°–¢–ò–õ–¨ –î–õ–Ø –ö–ù–û–ü–ö–ò –ê–î–ú–Ü–ù–ê --- */
        #admin-panel-link {
            display: none; /* –•–æ–≤–∞—î–º–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            background-color: var(--tg-button);
            color: var(--tg-button-text);
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="app-container">

        <a href="supplier-register.html" id="supplier-register-link">
            –í–∏ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫? <u>–°—Ç–∞—Ç–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º TavernaGroup</u>
        </a>
    
        <a href="admin.html" id="admin-panel-link">
            üëë –£–≤—ñ–π—Ç–∏ –≤ –ê–¥–º—ñ–Ω-–ü–∞–Ω–µ–ª—å
        </a>

        <header id="search-bar">
            <input type="search" id="search-input" placeholder="üîç –ü–æ—à—É–∫ –∑–∞ –Ω–∞–∑–≤–æ—é –∞–±–æ –∞—Ä—Ç–∏–∫—É–ª–æ–º...">
        </header>
    
        <div id="status-message" class="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    
        <main id="product-grid"></main>

    </div>

    <button id="cart-fab-button">üõí</button> 

    <script>
        const tg = window.Telegram.WebApp;
        
        // –í–ê–ñ–õ–ò–í–û: –í–∫–∞–∂–∏ —Ç—É—Ç URL —Ç–≤–æ–≥–æ Render API
        const API_BASE_URL = "https://taverna-bot-r028.onrender.com"; // –ó–ê–ú–Ü–ù–ò –¶–ï

        // –ï–ª–µ–º–µ–Ω—Ç–∏ DOM
        const searchInput = document.getElementById('search-input');
        const productGrid = document.getElementById('product-grid');
        const statusMessage = document.getElementById('status-message');
        
        let tgUser = null; // –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞

        // (–§—É–Ω–∫—Ü—ñ—ó apiCall —Ç–∞ authenticateUser —Ç–µ–ø–µ—Ä –≤ app.js)

        // 6. –§—É–Ω–∫—Ü—ñ—è "–º–∞–ª—é–≤–∞–Ω–Ω—è" –∫–∞—Ä—Ç–æ–∫
        function renderProducts(products) {
            productGrid.innerHTML = '';
            if (!products || products.length === 0) {
                statusMessage.innerText = '–¢–æ–≤–∞—Ä—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.';
                statusMessage.style.display = 'block';
                return;
            }
            statusMessage.style.display = 'none';
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.id = product.id; 
                
                const availableVariants = product.variants.filter(v => v.is_available);
                let minPrice = 0;
                if (availableVariants.length > 0) {
                    minPrice = Math.min(...availableVariants.map(v => v.final_price));
                }
                const imageUrl = product.pictures && product.pictures.length > 0 
                    ? product.pictures[0] 
                    : 'https://via.placeholder.com/150';

                card.innerHTML = `
                    <img src="${imageUrl}" alt="${product.name}" loading="lazy">
                    <div class="product-card-info">
                        <div class="product-card-name">${product.name}</div>
                        <div class="product-card-price">${minPrice > 0 ? minPrice + ' –≥—Ä–Ω' : '–ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'}</div>
                    </div>
                `;
                card.onclick = () => { onProductClick(product.id); };
                productGrid.appendChild(card);
            });
        }
        
        // 7. –§—É–Ω–∫—Ü—ñ—è –ø–æ—à—É–∫—É
        async function performSearch(query) {
            productGrid.innerHTML = '';
            statusMessage.innerText = '–®—É–∫–∞—î–º–æ...';
            statusMessage.style.display = 'block';
            
            const products = await apiCall(`/api/v1/search?query=${encodeURIComponent(query)}`);
            if (products && !products.error) {
                renderProducts(products);
            }
        }
        
        // 8. –û–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä
        function onProductClick(id) {
            tg.HapticFeedback.impactOccurred('light');
            window.location.href = `product-details.html?id=${id}`;
        }

        // 9. –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è (–û–ù–û–í–õ–ï–ù–û)
        async function main() {
            tg.ready();
            tg.expand();
            
            // 1. –°–ø–æ—á–∞—Ç–∫—É –∞–≤—Ç–æ—Ä–∏–∑—É—î–º–æ—Å—å
            tgUser = await authenticateUser();
            if (!tgUser) {
                statusMessage.innerText = "–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó. –ë—É–¥—å –ª–∞—Å–∫–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å MiniApp.";
                return; // –ó—É–ø–∏–Ω—è—î–º–æ
            }
            
            tg.BackButton.hide();

            // --- [–ü–õ–ê–ù 22] "GOD MODE" ---
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ä–æ–ª—å —é–∑–µ—Ä–∞, —è–∫–æ–≥–æ –º–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –∑ /auth/login-telegram
            if (tgUser.role === 'admin') {
                document.getElementById('admin-panel-link').style.display = 'block';
            }
            
            // 2. –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –ø–æ—à—É–∫
            let searchTimeout;
            searchInput.oninput = () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = searchInput.value;
                    if (query.length > 2) {
                        performSearch(query);
                    } else if (query.length === 0) {
                        statusMessage.innerText = '–í–≤–µ–¥—ñ—Ç—å –∑–∞–ø–∏—Ç –¥–ª—è –ø–æ—à—É–∫—É (–º—ñ–Ω. 3 —Å–∏–º–≤–æ–ª–∏).';
                        productGrid.innerHTML = '';
                    }
                }, 500); 
            };

            // 3. –ü—Ä–∏–≤'—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏ –∫–æ—à–∏–∫–∞
            document.getElementById('cart-fab-button').onclick = () => {
                tg.HapticFeedback.impactOccurred('light');
                window.location.href = 'cart.html';
            };
            
            // 4. –û–±—Ä–æ–±–∫–∞ Deep Link (–∑ –∫–∞–Ω–∞–ª—É)
            if (tg.initDataUnsafe?.start_param) {
                const startParam = tg.initDataUnsafe.start_param;
                if (startParam.startsWith('sku-')) {
                    const sku = startParam.split('-')[1];
                    searchInput.value = sku;
                    performSearch(sku);
                }
            } else {
                 statusMessage.innerText = '–í–≤–µ–¥—ñ—Ç—å –∑–∞–ø–∏—Ç –¥–ª—è –ø–æ—à—É–∫—É.';
                 // TODO: –¢—É—Ç –º–æ–∂–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ "–¢–æ–ø —Ç–æ–≤–∞—Ä–∏"
            }
        }
        
        main();
    </script>
</body>
</html>